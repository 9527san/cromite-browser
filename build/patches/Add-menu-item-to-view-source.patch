From: csagan5 <32685696+csagan5@users.noreply.github.com>
Date: Mon, 13 Jul 2020 00:37:06 +0200
Subject: Add menu item to view source

License: GPL-3.0-only - https://spdx.org/licenses/GPL-3.0-only.html
---
 .../chrome/browser/ChromeTabbedActivity.java    |  2 ++
 .../chrome/browser/app/ChromeActivity.java      |  5 +++++
 .../appmenu/AppMenuPropertiesDelegateImpl.java  | 17 +++++++++++++++++
 .../TabbedAppMenuPropertiesDelegate.java        |  1 +
 .../android/strings/android_chrome_strings.grd  |  4 ++++
 5 files changed, 29 insertions(+)

diff --git a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/ChromeTabbedActivity.java
@@ -3537,6 +3537,8 @@ public class ChromeTabbedActivity extends ChromeActivity {
                 NewTabPageUma.recordAction(NewTabPageUma.ACTION_OPENED_DOWNLOADS_MANAGER);
             }
             RecordUserAction.record("MobileMenuDownloadManager");
+        } else if (id == R.id.view_source_id) {
+            currentTab.getWebContents().getNavigationController().loadUrl(new LoadUrlParams("view-source:"+currentTab.getUrl().getSpec()));
         } else if (id == R.id.open_recently_closed_tab) {
             TabModel currentModel = mTabModelSelector.getCurrentModel();
             if (!currentModel.isIncognito()) currentModel.openMostRecentlyClosedEntry();
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/ChromeActivity.java
@@ -2577,6 +2577,11 @@ public abstract class ChromeActivity extends AsyncInitializationActivity
             return doOpenWebApk(currentTab);
         }
 
+        if (id == R.id.view_source_id) {
+            currentTab.getWebContents().getNavigationController().loadUrl(new LoadUrlParams("view-source:"+currentTab.getUrl().getSpec()));
+            return true;
+        }
+
         if (id == R.id.request_desktop_site_id || id == R.id.request_desktop_site_check_id) {
             boolean usingDesktopUserAgent =
                     currentTab.getWebContents().getNavigationController().getUseDesktopUserAgent();
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java b/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/app/appmenu/AppMenuPropertiesDelegateImpl.java
@@ -985,6 +985,23 @@ public abstract class AppMenuPropertiesDelegateImpl implements AppMenuProperties
         return false;
     }
 
+    /**
+     * Updates the view source menu item's state.
+     *
+     * @param menu {@link Menu} for view source.
+     * @param currentTab      Current tab being displayed.
+     */
+    protected void updateViewSourceMenuItem(
+            Menu menu, Tab currentTab) {
+        MenuItem viewSourceMenuItem = menu.findItem(R.id.view_source_id);
+        boolean visible = false;
+        if (currentTab != null) {
+                String url = currentTab.getUrl().getSpec();
+                visible = !url.isEmpty() && !url.startsWith("view-source:");
+        }
+        viewSourceMenuItem.setVisible(visible);
+    }
+
     /**
      * Updates the bookmark item's visibility.
      *
diff --git a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedAppMenuPropertiesDelegate.java b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedAppMenuPropertiesDelegate.java
--- a/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedAppMenuPropertiesDelegate.java
+++ b/chrome/android/java/src/org/chromium/chrome/browser/tabbed_mode/TabbedAppMenuPropertiesDelegate.java
@@ -384,6 +384,7 @@ public class TabbedAppMenuPropertiesDelegate extends AppMenuPropertiesDelegateIm
 
         Add exit menu item
         Add always incognito item
+        Add view source item
     }
 
     private Runnable buildUpdateStateChangedObserver() {
diff --git a/chrome/browser/ui/android/strings/android_chrome_strings.grd b/chrome/browser/ui/android/strings/android_chrome_strings.grd
--- a/chrome/browser/ui/android/strings/android_chrome_strings.grd
+++ b/chrome/browser/ui/android/strings/android_chrome_strings.grd
@@ -321,6 +321,10 @@ CHAR_LIMIT guidelines:
         Collaboration
       </message>
 
+      <message name="IDS_VIEW_SOURCE" desc="Title for the menu command to view the source of the current page. [CHAR-LIMIT=40]">
+        View source
+      </message>
+
       <!-- Sign-in, sync and personalization preferences -->
       <message name="IDS_PREFS_SECTION_ACCOUNT_AND_GOOGLE_SERVICES" desc="Title for the group of account-related entries and google services in Settings. [CHAR_LIMIT=32]">
         You and Google
--
